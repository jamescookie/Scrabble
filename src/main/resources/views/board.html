<!DOCTYPE html>
<html lang="en" th:replace="~{layoutFile :: layout(~{::title}, ~{::style}, ~{::section}, ~{::script})}"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Play Scrabble</title>
    <style>
        #board .square {
            height: 32px;
            width: 32px;
            position: relative;
            background-color: #CDC6A9;
        }
        #board .square.DW {
            background-color: #F9BEAE;
        }
        #board .square.TW {
            background-color: #FC6353;
        }
        #board .square.DL {
            background-color: #C0D6D3;
        }
        #board .square.TL {
            background-color: #3F99B4;
        }
        #board .square.DW.START {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='30'%3E%3Cpolygon points='15,2 6,27 29,9 2,9 24,27' fill='black'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
        }
        #board .letter {
            background-color: ivory;
            text-transform: uppercase;
            padding: 0;
            width: 80%;
            height: 80%;
            display: table;
            text-align: center;
            vertical-align: middle;
            position: absolute;
            top: 10%;
            left: 10%;
            border-radius: 10%;
        }
        #board .fake {
            opacity: 60%;
        }
        #board .wildcard {
            color: lightgray;
        }
    </style>
</head>
<body>
<section>
    <table id="board">
        <tr th:each="row,rowIter: ${squares}">
            <td th:each="square,colIter: ${row}" th:attr="x=${colIter.index},y=${rowIter.index}" th:class="'square '+${square}"/>
        </tr>
    </table>

    <form id="tray">
        <input type="number" id="numberOfPossibilities" value="10">
        <input type="number" id="secondsToWait" value="5">
        <input type="text" id="letters">
        <input type="submit" value="Find Possibilities">
    </form>
    <ol id="results">

    </ol>
    <div id="error"></div>
</section>
<script th:inline="javascript">
    /*<![CDATA[*/
    let board = /*[[${board}]]*/ '';
    let boardSize = /*[[${size}]]*/ '';
    let wildcardChar = /*[[${wildcard}]]*/ '';

    let renderBoard = function () {
        let $board = $('#board');
        let rows = board.split('\n');
        for (let i = 0; i < boardSize; i++) {
            let $row = $($('tr', $board)[i])
            for (let j = 0; j < boardSize; j++) {
                let contents = rows[i][j];
                let $cell = $($('td', $row)[j]);
                let wildcard = contents === wildcardChar;
                if (wildcard) {
                    j++;
                    contents = rows[i][j];
                }
                if (contents === ' ') {
                    $cell.empty();
                } else {
                    $cell.html('<div class="letter'+(wildcard?' wildcard':'')+'">' + contents + '</div>');
                }
            }
        }
    }

    function dealWithResponse(response) {
        let $results = $('#results');
        $results.empty();
        $.each(response.results, function (index, value) {
            $results.append($('<li>', value).text(value.letters + " (" + value.score + ")").append($('<button>').addClass('add').text('Add')).append($('<button>').addClass('show').text('Show')));
        });
        board = response.board;
        renderBoard();
    }

    let putDownLetters = function (attrs) {
        let formData = {
            board: board,
            add: attrs
        };

        $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            type: "POST",
            url: "/add-word",
            data: JSON.stringify(formData),
            dataType: "json"
        }).done(dealWithResponse).fail(function (data) {
            console.log(data);
            $("#error").html(
                '<div class="alert alert-danger">' + data.responseText + '</div>'
            );
        });
    }

    let showWord = function (element) {
        $("#board .fake").remove();
        let $possibility = $(element);
        let across = $possibility.attr("direction") === "ACROSS";
        let letters = $possibility.attr("letters");
        let x = $possibility.attr("x");
        let y = $possibility.attr("y");
        let wildcard = false;
        for (let i = 0; i < letters.length; i++) {
            if (letters[i] === wildcardChar) {
                wildcard = true;
                continue;
            }
            let $square = $(".square[x='"+x+"'][y='"+y+"']");
            let $letter = $('.letter', $square);
            if ($letter.length === 0) {
                $square.append('<div class="letter fake'+(wildcard?' wildcard':'')+'">'+letters[i]+'</div>')
            } else {
                i--;
            }
            if (across) {
                x++;
            } else {
                y++;
            }
            wildcard = false;
        }
    }

    let addWord = function (element) {
        let attrs = {};
        Object.values(($(element))[0].attributes).map(attr => attrs[attr.name] = attr.value);
        putDownLetters(attrs);
    }

    $(document).ready(function () {
        renderBoard();

        $("#board").on('click', '.square', function () {
            let $this = $(this);
            let letters = prompt("Please enter the letters:");
            if (letters !== null && letters !== "") {
                let attrs = {
                    letters: letters,
                    x: $this.attr("x"),
                    y: $this.attr("y")
                };
                if (confirm("Across?")) {
                    attrs.direction = 'ACROSS';
                } else {
                    attrs.direction = 'DOWN';
                }
                putDownLetters(attrs);
            }
        });

        $("#results").on('click', '.add', function () {
            addWord($(this).parent());
        });

        $("#results").on('click', '.show', function () {
            showWord($(this).parent());
        });

        $("#tray").submit(function (event) {
            let formData = {
                board: board,
                secondsToWait: $("#secondsToWait").val(),
                numberOfPossibilities: $("#numberOfPossibilities").val(),
                letters: $("#letters").val()
            };

            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                type: "POST",
                url: "/find-words",
                data: JSON.stringify(formData),
                dataType: "json"
            }).done(dealWithResponse).fail(function (data) {
                console.log(data);
                $("#error").html(
                    '<div class="alert alert-danger">' + data.responseText + '</div>'
                );
            });

            event.preventDefault();
        });
    });

    /*]]>*/
</script>
</body>
</html>
